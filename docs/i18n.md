## i18n 設計ガイド

### 特徴

- デフォルト言語（日本語）は `/` にルーティング
- 他言語は `/en` のようにプレフィックス付き
- ページはメッセージをインライン定義
- コンポーネントは外部 `*.i18n.ts` ファイルで文言管理
- 共通メッセージは `common.i18n.ts` で一元管理
- `t('key.path')` でドットアクセス

### ファイル構成

```
src/
├── components/
│   ├── ButtonLang/
│   │   ├── ButtonLang.astro
│   │   └── ButtonLang.i18n.ts
│   ├── Categories/
│   │   ├── Categories.astro
│   │   └── Categories.i18.ts
│   └── Pagination/
│       ├── Pagination.astro
│       └── Pagination.i18n.ts
├── data/
│   └── news.ts
├── libs/
│   └── i18n/
│       ├── config.ts
│       ├── helpers.ts
│       ├── useI18n.ts
│       ├── common.i18n.ts
│       └── index.ts
└── pages/
    └── [...lang]/
        ├── index.astro
        ├── about/
        │   └── index.astro
        └── news/
            ├── [id].astro
            └── category/[category]/[...page].astro
```

## API

### `useI18n(Astro, messages)`

メインの i18n フック。

```ts
const { lang, langPrefix, t, localePath } = useI18n(Astro, messages);
```

| 戻り値       | 型                                                               | 説明                                 |
| ------------ | ---------------------------------------------------------------- | ------------------------------------ |
| `lang`       | `'ja' \| 'en'`                                                   | 現在の言語                           |
| `langPrefix` | `string`                                                         | URLプレフィックス（`''` or `'/en'`） |
| `t`          | `(path: string, placeholders?: Record<string,string>) => string` | 翻訳関数                             |
| `localePath` | `(path: string) => string`                                       | 言語対応パス生成                     |

### `getLanguagePaths(extend?)`

`getStaticPaths` 用のパス配列を生成。

```astro
---
import { getLanguagePaths } from '@libs/i18n';

export function getStaticPaths() {
  return [...getLanguagePaths()];
}
---
```

拡張パラメータを追加する場合:

```astro
---
import { getLanguagePaths } from '@libs/i18n';

export function getStaticPaths() {
  return [
    ...getLanguagePaths((lang) => ({
      params: { slug: 'hello' },
      props: { someData: getData(lang) },
    })),
  ];
}
---
```

### `localePath(path)`

現在の言語に応じたパスを生成。

```astro
<a href={localePath('/news')}>News</a>
<!-- 日本語: "/news" -->
<!-- 英語: "/en/news" -->
```

### `t(path, placeholders?)`

ドットパスで翻訳を取得。<br>
第二引数にオブジェクトを渡すと、文字列内の `%key%` をプレースホルダーとして置換できる。<br>
見つからない場合はキー名をそのまま返す。

```ts
// 単純なキー の場合
t('title'); // ローカルメッセージ
t('nav.home'); // ネストしたキー
t('common.loading'); // 共通メッセージ
```

```ts
// プレースホルダー付き の場合
messages: {
  ja: { pageLabel: '%pageNumber%ページへ移動する' },
  en: { pageLabel: 'Go to page %pageNumber%' }
}

t('pageLabel', { pageNumber: '3' });
```

```ts
// プレースホルダーが複数ある場合
messages: {
  ja: { summary: '%name% さんの未読は %count% 件です' },
  en: { summary: '%name% has %count% unread items' }
}

t('summary', { name: '太郎', count: '3' });
```

---

## 設定

`src/libs/i18n/config.ts` で設定を管理:

```ts
export const i18nConfig = {
  languages: ['ja', 'en'] as const,
  defaultLang: 'ja' as const,
  prefixDefaultLang: false, // true: /ja/about, false: /about
};
```

---

## 言語の追加

1. `src/libs/i18n/config.ts` の `languages` に追加:

   ```ts
   export const i18nConfig = {
     languages: ['ja', 'en', 'fr'] as const,
     // ...
   };
   ```

2. `common.i18n.ts` に翻訳を追加
3. 各ページ・コンポーネントの `messages` に追加

---

## ルーティングと URL の挙動

- 日本語（デフォルト言語）
  - `/`
  - `/news/`
  - `/news/:id`
  - `/news/category/:category/:page?`
- 英語
  - `/en/`
  - `/en/news/`
  - `/en/news/:id`
  - `/en/news/category/:category/:page?`

テンプレート側では `localePath('/news')` などを使うことで、言語を意識せず URL を生成できます。

## データファイル（Content的な使い方）

microCMS からエクスポートした JSON を言語別に管理し、`news.ts` でラップして使う。

```
src/data/
├── news.ts                 # データアクセス層
└── json/
    ├── news/
    │   ├── ja.json         # 日本語ニュース一覧
    │   └── en.json         # 英語ニュース一覧
    └── categories/
        ├── ja.json         # 日本語カテゴリ一覧
        └── en.json         # 英語カテゴリ一覧
```

```ts
// news.ts（抜粋）
import type { Lang } from '@libs/i18n';
import enNewsData from './json/news/en.json' with { type: 'json' };
import jaNewsData from './json/news/ja.json' with { type: 'json' };

const news: Record<Lang, Post[]> = {
  ja: jaNewsData as Post[],
  en: enNewsData as Post[],
};

export const getNews = (lang: Lang): Post[] => news[lang];
export const getAllNews = (): { lang: Lang; news: Post }[] =>
  (Object.entries(news) as [Lang, Post[]][]).flatMap(([lang, langNews]) =>
    langNews.map((news) => ({ lang, news })),
  );
```

動的ルートでの使用（ニュース詳細）:

```astro
---
import { getAllNews } from '@data/news';
import Layout from '@layouts/Layout.astro';
import { formatDate } from '@libs/data-time-fotmatter';
import { getLangParam, useI18n } from '@libs/i18n';

export function getStaticPaths() {
  return getAllNews().map(({ lang, news }) => ({
    params: {
      lang: getLangParam(lang),
      id: news.id,
    },
    props: { news },
  }));
}

const { news } = Astro.props;

const messages = {
  ja: { title: `最新情報 - ${news.title}` },
  en: { title: `Latest News - ${news.title}` },
};

const { lang, t } = useI18n(Astro, messages);
---

<Layout title={t('title')}>
  <p>{formatDate(news.publishedAt, lang)}</p>
  <h1 set:html={news.title} />
</Layout>
```
