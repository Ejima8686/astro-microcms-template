# i18n 設計ガイド

## 特徴

- デフォルト言語（日本語）は `/` にルーティング
- 他言語は `/en` のようにプレフィックス付き
- ページはメッセージをインライン定義
- コンポーネントは外部 `*.i18n.ts` ファイルで文言管理
- 共通メッセージは `common.i18n.ts` で一元管理
- `t('key.path')` でドットアクセス

## ファイル構成

```text
src/
├── components/
│   ├── ButtonLang/
│   │   ├── ButtonLang.astro
│   │   └── ButtonLang.i18n.ts
│   ├── Categories/
│   │   ├── Categories.astro
│   │   └── Categories.i18.ts
│   └── Pagination/
│       ├── Pagination.astro
│       └── Pagination.i18n.ts
├── data/
│   └── news.ts
├── libs/
│   └── i18n/
│       ├── config.ts
│       ├── helpers.ts
│       ├── useI18n.ts
│       ├── common.i18n.ts
│       └── index.ts
└── pages/
    └── [...lang]/
        ├── index.astro
        ├── about/
        │   └── index.astro
        └── news/
            ├── [id].astro
            └── category/[category]/[...page].astro
```

## API

### `useI18n(Astro, messages)`

メインの i18n フック。

```ts
const { lang, langPrefix, t, localePath } = useI18n(Astro, messages);
```

| 戻り値       | 型                                                               | 説明                                 |
| ------------ | ---------------------------------------------------------------- | ------------------------------------ |
| `lang`       | `'ja' \| 'en'`                                                   | 現在の言語                           |
| `langPrefix` | `string`                                                         | URLプレフィックス（`''` or `'/en'`） |
| `t`          | `(path: string, placeholders?: Record<string,string>) => string` | 翻訳関数                             |
| `localePath` | `(path: string) => string`                                       | 言語対応パス生成                     |

### `getLanguagePaths(extend?)`

`getStaticPaths` 用のパス配列を生成。

```astro
---
import { getLanguagePaths } from '@libs/i18n';

export function getStaticPaths() {
  return [...getLanguagePaths()];
}
---
```

拡張パラメータを追加する場合:

```astro
---
import { getLanguagePaths } from '@libs/i18n';

export function getStaticPaths() {
  return [
    ...getLanguagePaths((lang) => ({
      params: { slug: 'hello' },
      props: { someData: getData(lang) },
    })),
  ];
}
---
```

**注意**: `extend` コールバックの戻り値は `params` と `props` を持つオブジェクトです。`params` はURLパラメータ、`props` はページコンポーネントに渡されるプロパティです。

### `localePath(path)`

現在の言語に応じたパスを生成。

```astro
<a href={localePath('/news')}>News</a>
<!-- 日本語: "/news" -->
<!-- 英語: "/en/news" -->
```

### `t(path, placeholders?)`

ドットパスで翻訳を取得。
第二引数にオブジェクトを渡すと、文字列内の `%key%` をプレースホルダーとして置換できる。
見つからない場合はキー名をそのまま返す。

```ts
// 単純なキー の場合
t('title'); // ローカルメッセージ
t('nav.home'); // ネストしたキー
t('common.loading'); // 共通メッセージ
```

```ts
// プレースホルダー付き の場合
messages: {
  ja: { pageLabel: '%pageNumber%ページへ移動する' },
  en: { pageLabel: 'Go to page %pageNumber%' }
}

t('pageLabel', { pageNumber: '3' });
```

```ts
// プレースホルダーが複数ある場合
messages: {
  ja: { summary: '%name% さんの未読は %count% 件です' },
  en: { summary: '%name% has %count% unread items' }
}

t('summary', { name: '太郎', count: '3' });
```

---

## 設定

`src/libs/i18n/config.ts` で設定を管理:

```ts
export const i18nConfig = {
  languages: ['ja', 'en'] as const,
  defaultLang: 'ja' as const,
  prefixDefaultLang: false, // true: /ja/about, false: /about
};
```

---

## 言語の追加

1. `src/libs/i18n/config.ts` の `languages` に追加:

   ```ts
   export const i18nConfig = {
     languages: ['ja', 'en', 'fr'] as const,
     // ...
   };
   ```

2. `common.i18n.ts` に翻訳を追加
3. 各ページ・コンポーネントの `messages` に追加

---

## ルーティングと URL の挙動

- 日本語（デフォルト言語）
  - `/`
  - `/news/`
  - `/news/:id`
  - `/news/category/:category/`（ページネーション対応）
- 英語
  - `/en/`
  - `/en/news/`
  - `/en/news/:id`
  - `/en/news/category/:category/`（ページネーション対応）

テンプレート側では `localePath('/news')` などを使うことで、言語を意識せず URL を生成できます。

## データファイル（Content的な使い方）

microCMS からエクスポートした JSON を言語別に管理し、`news.ts` でラップして使う。

```text
src/data/
├── news.ts                 # データアクセス層
└── json/
    └── news/
        ├── ja.json         # 日本語ニュース一覧
        ├── en.json         # 英語ニュース一覧
        └── categories.json # カテゴリ一覧（言語共通）
```

```ts
// news.ts（抜粋）
import type { Lang } from '@libs/i18n';
import enNewsData from './json/news/en.json' with { type: 'json' };
import jaNewsData from './json/news/ja.json' with { type: 'json' };
import categoriesData from './json/news/categories.json' with { type: 'json' };

const news: Record<Lang, NewsPost[]> = {
  ja: jaNewsData as NewsPost[],
  en: enNewsData as NewsPost[],
};

const categories: Record<Lang, NewsCategory[]> = {
  ja: categoriesData as NewsCategory[],
  en: categoriesData as NewsCategory[],
};

export const getNews = (lang: Lang, sort = true): NewsPost[] => {
  if (sort) {
    return news[lang].sort(
      (a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime(),
    );
  }
  return news[lang];
};

export const getAllNews = (): { lang: Lang; news: NewsPost }[] =>
  (Object.entries(news) as [Lang, NewsPost[]][]).flatMap(([lang, langNews]) =>
    langNews.map((news) => ({ lang, news })),
  );

export const getCategories = (lang: Lang): { name: string; id: string }[] => {
  return categories[lang].map((category) => ({ name: category.name, id: category.id }));
};
```

動的ルートでの使用（ニュース詳細）:

```astro
---
import { getAllNews } from '@data/news';
import Layout from '@layouts/Layout.astro';
import { formatDate } from '@libs/data-time-fotmatter';
import { getLangParam, useI18n } from '@libs/i18n';

export function getStaticPaths() {
  return getAllNews().map(({ lang, news }) => ({
    params: {
      lang: getLangParam(lang),
      id: news.id,
    },
    props: { news },
  }));
}

const { news } = Astro.props;

const messages = {
  ja: {
    title: `最新情報 - ${news.title}`,
    description: `最新情報 - ${news.title}`,
    backToList: '一覧へ戻る',
  },
  en: {
    title: `Latest News - ${news.title}`,
    description: `Latest News - ${news.title}`,
    backToList: 'Back to list',
  },
};

const { lang, t, localePath } = useI18n(Astro, messages);
---

<Layout title={t('title')}>
  <main>
    <div class="mx-auto my-10 max-w-screen-sm">
      <p class="text-sm text-gray-500">{formatDate(news.publishedAt, lang)}</p>
      <h1 class="mt-2 text-2xl font-bold" set:html={news.title} />
      <div class="prose mt-10" set:html={news.content} />
      <div class="mt-10 text-center">
        <a href={localePath('/news/')}>{t('backToList')}</a>
      </div>
    </div>
  </main>
</Layout>
```
